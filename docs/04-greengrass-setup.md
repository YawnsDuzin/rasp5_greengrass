# 04. AWS IoT Greengrass 설정

이 문서에서는 AWS IoT Greengrass V2를 설정하여 라즈베리파이에서 엣지 컴퓨팅 환경을 구축합니다.

## 목차
1. [Greengrass V2 개요](#1-greengrass-v2-개요)
2. [Greengrass Core 디바이스 등록](#2-greengrass-core-디바이스-등록)
3. [컴포넌트 개념 이해](#3-컴포넌트-개념-이해)
4. [배포(Deployment) 이해](#4-배포deployment-이해)
5. [S3 버킷 생성](#5-s3-버킷-생성)

---

## 1. Greengrass V2 개요

### 1.1 Greengrass V2란?

AWS IoT Greengrass V2는 엣지 디바이스에서 로컬 컴퓨팅, 메시징, 데이터 캐싱, ML 추론을 실행할 수 있게 해주는 오픈 소스 IoT 엣지 런타임입니다.

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      Greengrass V2 아키텍처                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│                          AWS 클라우드                                    │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                    Greengrass 클라우드 서비스                      │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │  │
│  │  │ 컴포넌트    │  │   배포      │  │  디바이스 관리          │  │  │
│  │  │ 저장소      │  │   관리      │  │                         │  │  │
│  │  └─────────────┘  └─────────────┘  └─────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                   │                                     │
│                                   │ 배포/업데이트                        │
│                                   ▼                                     │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │              Greengrass Core 디바이스 (라즈베리파이)               │  │
│  │  ┌────────────────────────────────────────────────────────────┐ │  │
│  │  │                    Greengrass Nucleus                      │ │  │
│  │  │                    (핵심 런타임)                            │ │  │
│  │  └────────────────────────────────────────────────────────────┘ │  │
│  │                              │                                   │  │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌──────────────┐ │  │
│  │  │ PPE        │ │  MQTT      │ │   Log      │ │   Secret     │ │  │
│  │  │ Detector   │ │  Bridge    │ │   Manager  │ │   Manager    │ │  │
│  │  │ (우리 앱)   │ │            │ │            │ │              │ │  │
│  │  └────────────┘ └────────────┘ └────────────┘ └──────────────┘ │  │
│  │        커스텀 컴포넌트        AWS 제공 컴포넌트                   │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.2 Greengrass V2의 장점

| 특징 | 설명 |
|------|------|
| **오프라인 동작** | 인터넷 연결 없이도 로컬에서 작동 |
| **로컬 ML 추론** | PPE 인식을 클라우드 전송 없이 처리 |
| **원격 배포** | 콘솔에서 컴포넌트 업데이트 |
| **모듈식 구조** | 필요한 기능만 선택적으로 배포 |
| **보안** | 자동 인증서 교체, 암호화 통신 |

### 1.3 V1 vs V2

```
┌─────────────────────────────────────────────────────────────┐
│              Greengrass V1 vs V2 비교                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  V1 (레거시):                                                │
│  · Lambda 함수 기반                                         │
│  · 복잡한 설정                                              │
│  · 제한적인 언어 지원                                        │
│                                                             │
│  V2 (현재 권장):          ✓ 우리 프로젝트는 V2 사용         │
│  · 컴포넌트 기반 (유연함)                                   │
│  · 간단한 CLI 설치                                          │
│  · 모든 언어/런타임 지원                                    │
│  · 오픈 소스                                                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. Greengrass Core 디바이스 등록

### 2.1 Greengrass 콘솔 접속

1. AWS 콘솔 상단 검색창에 **"IoT Greengrass"** 입력
2. **"AWS IoT Greengrass"** 서비스 클릭

```
┌─────────────────────────────────────────────────────────────────────────┐
│  AWS IoT Greengrass                                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  좌측 메뉴:                                                             │
│  ┌─────────────────────────────────────────┐                           │
│  │ Greengrass 디바이스                      │                           │
│  │   └ 코어 디바이스 (Core devices)        │◀── 디바이스 등록/관리      │
│  │   └ 클라이언트 디바이스                  │                           │
│  │                                         │                           │
│  │ 배포 (Deployments)                      │◀── 컴포넌트 배포          │
│  │                                         │                           │
│  │ 컴포넌트 (Components)                   │◀── 컴포넌트 관리          │
│  │                                         │                           │
│  └─────────────────────────────────────────┘                           │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 코어 디바이스 설정

라즈베리파이에 Greengrass를 설치하기 전에 필요한 정보를 확인합니다.

#### 방법 A: 자동 프로비저닝 (권장)

AWS CLI를 사용하여 라즈베리파이에서 직접 설치 시 자동으로 등록됩니다.
이 방법은 [05. 라즈베리파이 설정](05-raspberry-pi-setup.md)에서 자세히 다룹니다.

#### 방법 B: 수동 프로비저닝

수동으로 코어 디바이스를 먼저 등록하려면:

1. **"코어 디바이스(Core devices)"** 클릭
2. **"코어 디바이스 설정(Set up core device)"** 클릭

```
┌─────────────────────────────────────────────────────────────┐
│                   코어 디바이스 설정                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1단계: 코어 디바이스 등록                                   │
│  ─────────────────────────────────────────────────────────  │
│                                                             │
│  코어 디바이스 이름*: [RaspberryPi5-PPE        ]            │
│                                                             │
│  사물 그룹 (선택사항):                                       │
│  [새 그룹 입력                             ▼]               │
│  [PPEDetectorGroup                          ]               │
│                                                             │
│  ─────────────────────────────────────────────────────────  │
│                                                             │
│  운영 체제: (●) Linux                                       │
│                                                             │
│  [다음]                                                      │
└─────────────────────────────────────────────────────────────┘
```

### 2.3 설치 스크립트 생성

콘솔에서 설치 명령어를 생성할 수 있습니다:

```
┌─────────────────────────────────────────────────────────────┐
│                   2단계: 설치 실행                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  다음 명령을 라즈베리파이에서 실행하세요:                      │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ curl -s https://d2s8p88vqu9w66.cloudfront.net/     │   │
│  │   releases/greengrass-nucleus-latest.zip           │   │
│  │   -o greengrass-nucleus-latest.zip && unzip ...    │   │
│  │                                                     │   │
│  │ sudo -E java -Droot="/greengrass/v2" ...           │   │
│  │   --aws-region ap-northeast-2                      │   │
│  │   --thing-name RaspberryPi5-PPE                    │   │
│  │   --thing-group-name PPEDetectorGroup              │   │
│  │   --component-default-user ggc_user:ggc_group      │   │
│  │   ...                                               │   │
│  │                                           [복사]    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  [완료]                                                      │
└─────────────────────────────────────────────────────────────┘
```

> 이 명령어는 [05. 라즈베리파이 설정](05-raspberry-pi-setup.md)에서 사용합니다.

---

## 3. 컴포넌트 개념 이해

### 3.1 컴포넌트란?

컴포넌트는 Greengrass에서 실행되는 소프트웨어 모듈입니다. 레고 블록처럼 조합하여 사용합니다.

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         컴포넌트 구조                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌────────────────────────────────────────────────────────────────┐   │
│  │                    컴포넌트 (Component)                         │   │
│  │                                                                 │   │
│  │   ┌─────────────────────┐   ┌─────────────────────────────┐   │   │
│  │   │   레시피 (Recipe)    │   │   아티팩트 (Artifacts)       │   │   │
│  │   │                     │   │                             │   │   │
│  │   │  · 이름, 버전        │   │  · 실행 파일                │   │   │
│  │   │  · 의존성            │   │  · 라이브러리                │   │   │
│  │   │  · 라이프사이클      │   │  · 설정 파일                │   │   │
│  │   │  · 설정             │   │  · ML 모델                  │   │   │
│  │   │                     │   │                             │   │   │
│  │   │  recipe.yaml        │   │  main.py, model.pt, ...    │   │   │
│  │   └─────────────────────┘   └─────────────────────────────┘   │   │
│  └────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 컴포넌트 유형

| 유형 | 제공자 | 예시 |
|------|--------|------|
| **AWS 제공 컴포넌트** | AWS | Nucleus, MQTT Bridge, Log Manager |
| **커뮤니티 컴포넌트** | 오픈 소스 | 다양한 공개 컴포넌트 |
| **커스텀 컴포넌트** | 사용자 (우리) | PPE Detector |

### 3.3 주요 AWS 컴포넌트

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    자주 사용하는 AWS 컴포넌트                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  aws.greengrass.Nucleus (필수)                                          │
│  └─ Greengrass 핵심 런타임, 모든 컴포넌트의 기반                         │
│                                                                         │
│  aws.greengrass.Cli                                                     │
│  └─ 로컬에서 Greengrass CLI 사용                                        │
│     예: greengrass-cli component list                                   │
│                                                                         │
│  aws.greengrass.clientdevices.mqtt.Bridge                               │
│  └─ 로컬 MQTT ↔ AWS IoT Core MQTT 브릿지                               │
│     PPE 알림을 클라우드로 전송할 때 필요                                 │
│                                                                         │
│  aws.greengrass.LogManager                                              │
│  └─ 로그를 CloudWatch로 전송                                            │
│     디버깅에 유용                                                       │
│                                                                         │
│  aws.greengrass.SecretManager                                           │
│  └─ 비밀(Secret) 관리                                                   │
│     API 키 등 민감 정보 저장                                            │
│                                                                         │
│  aws.greengrass.StreamManager                                           │
│  └─ 데이터 스트림 관리                                                  │
│     대용량 데이터를 클라우드로 전송                                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.4 레시피(Recipe) 구조

레시피는 YAML 또는 JSON 형식으로 작성합니다:

```yaml
# recipe.yaml 예시
---
RecipeFormatVersion: "2020-01-25"

ComponentName: com.example.PPEDetector
ComponentVersion: "1.0.0"
ComponentDescription: PPE Detection component using YOLOv8
ComponentPublisher: MyCompany

# 다른 컴포넌트에 대한 의존성
ComponentDependencies:
  aws.greengrass.Nucleus:
    VersionRequirement: ">=2.0.0"
    DependencyType: HARD

# 컴포넌트 실행에 필요한 파일들
Manifests:
  - Platform:
      os: linux
      architecture: arm64   # 라즈베리파이5는 arm64
    Lifecycle:
      Install:
        Script: pip3 install -r {artifacts:path}/requirements.txt
      Run:
        Script: python3 {artifacts:path}/main.py
    Artifacts:
      - Uri: s3://your-bucket/ppe-detector/1.0.0/ppe-detector.zip
        Unarchive: ZIP

# 설정 값
ComponentConfiguration:
  DefaultConfiguration:
    rtspUrl: "rtsp://192.168.1.100:554/stream"
    confidenceThreshold: 0.5
    alertTopic: "ppe/alerts"
```

---

## 4. 배포(Deployment) 이해

### 4.1 배포란?

배포는 특정 컴포넌트들을 코어 디바이스에 설치하고 실행하는 작업입니다.

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          배포 흐름                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  1. 배포 생성                                                           │
│     ┌─────────────────────────────────────────────────────────────┐    │
│     │  배포 대상: RaspberryPi5-PPE (또는 사물 그룹)                │    │
│     │  컴포넌트:                                                  │    │
│     │    - com.example.PPEDetector (1.0.0)                       │    │
│     │    - aws.greengrass.Cli (2.9.0)                            │    │
│     │    - aws.greengrass.clientdevices.mqtt.Bridge              │    │
│     └─────────────────────────────────────────────────────────────┘    │
│                                   │                                     │
│                                   ▼                                     │
│  2. 클라우드 → 디바이스 전송                                            │
│     ┌─────────────────────────────────────────────────────────────┐    │
│     │  AWS 클라우드                         라즈베리파이            │    │
│     │  ┌───────────┐    배포 알림          ┌──────────────┐       │    │
│     │  │ Greengrass│ ─────────────────────▶│  Greengrass  │       │    │
│     │  │ Service   │                       │  Nucleus     │       │    │
│     │  └───────────┘                       └──────────────┘       │    │
│     │                                             │                │    │
│     │       S3 버킷                               │                │    │
│     │  ┌───────────┐    아티팩트 다운로드         │                │    │
│     │  │ 컴포넌트  │◀────────────────────────────┘                │    │
│     │  │ 아티팩트  │                                              │    │
│     │  └───────────┘                                              │    │
│     └─────────────────────────────────────────────────────────────┘    │
│                                   │                                     │
│                                   ▼                                     │
│  3. 디바이스에서 설치 및 실행                                           │
│     ┌─────────────────────────────────────────────────────────────┐    │
│     │  Install 스크립트 실행 (의존성 설치)                         │    │
│     │            │                                                │    │
│     │            ▼                                                │    │
│     │  Run 스크립트 실행 (컴포넌트 시작)                          │    │
│     │            │                                                │    │
│     │            ▼                                                │    │
│     │  상태 보고 → 클라우드                                       │    │
│     └─────────────────────────────────────────────────────────────┘    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.2 배포 대상

| 대상 유형 | 설명 | 사용 시나리오 |
|----------|------|-------------|
| **단일 코어 디바이스** | 특정 디바이스 1개 | 테스트, 개별 설정 |
| **사물 그룹** | 그룹 내 모든 디바이스 | 대량 배포, 동일 설정 |

### 4.3 배포 상태

```
배포 상태 흐름:

  ┌──────────────┐
  │   QUEUED     │  배포 대기 중
  └──────┬───────┘
         │
         ▼
  ┌──────────────┐
  │ IN_PROGRESS  │  배포 진행 중
  └──────┬───────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
┌────────┐ ┌────────┐
│COMPLETED│ │ FAILED │
│  성공   │ │  실패  │
└────────┘ └────────┘
```

---

## 5. S3 버킷 생성

컴포넌트 아티팩트(소스 코드, 모델 파일)를 저장할 S3 버킷을 생성합니다.

### 5.1 S3 콘솔 접속

1. AWS 콘솔 검색창에 **"S3"** 입력
2. **"S3"** 서비스 클릭

### 5.2 버킷 생성

1. **"버킷 만들기(Create bucket)"** 클릭

```
┌─────────────────────────────────────────────────────────────┐
│                      버킷 만들기                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  일반 구성                                                   │
│  ─────────────────────────────────────────────────────────  │
│                                                             │
│  버킷 이름*: [ppe-detector-artifacts-12345   ]             │
│             └─ 전역에서 고유해야 함! 계정ID 추가 권장         │
│                                                             │
│  AWS 리전: 아시아 태평양 (서울) ap-northeast-2              │
│                                                             │
│  ─────────────────────────────────────────────────────────  │
│  객체 소유권                                                 │
│  (●) ACL 비활성화됨 (권장)                                   │
│                                                             │
│  ─────────────────────────────────────────────────────────  │
│  이 버킷의 퍼블릭 액세스 차단 설정                            │
│  ☑ 모든 퍼블릭 액세스 차단 (권장)                           │
│                                                             │
│  ─────────────────────────────────────────────────────────  │
│  버킷 버전 관리                                              │
│  ( ) 활성화                                                  │
│  (●) 비활성화                                                │
│                                                             │
│  [버킷 만들기]                                               │
└─────────────────────────────────────────────────────────────┘
```

### 5.3 버킷 정책 설정

Greengrass가 S3에서 아티팩트를 다운로드할 수 있도록 정책을 설정합니다.

1. 생성된 버킷 클릭
2. **"권한(Permissions)"** 탭
3. **"버킷 정책(Bucket policy)"** → **"편집"**

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "AllowGreengrassAccess",
            "Effect": "Allow",
            "Principal": {
                "Service": "greengrass.amazonaws.com"
            },
            "Action": [
                "s3:GetObject"
            ],
            "Resource": "arn:aws:s3:::ppe-detector-artifacts-12345/*"
        }
    ]
}
```

> ⚠️ `ppe-detector-artifacts-12345`를 실제 버킷 이름으로 변경하세요!

### 5.4 폴더 구조 생성

버킷 내에 다음 구조로 폴더를 만듭니다:

```
📁 ppe-detector-artifacts-12345/
├── 📁 components/
│   └── 📁 com.example.PPEDetector/
│       └── 📁 1.0.0/
│           └── 📄 ppe-detector.zip    # 나중에 업로드
└── 📁 models/
    └── 📁 ppe-yolov8/
        └── 📄 best.pt                  # 나중에 업로드
```

### 5.5 폴더 생성 방법

1. 버킷 선택 → **"폴더 만들기(Create folder)"**
2. 폴더 이름: `components` → **"폴더 만들기"**
3. `components` 폴더 진입 → **"폴더 만들기"**
4. 폴더 이름: `com.example.PPEDetector` → **"폴더 만들기"**
5. 같은 방식으로 `1.0.0`, `models/ppe-yolov8` 생성

---

## 요약

이 문서에서 배운 내용:

| 항목 | 설명 |
|------|------|
| **Greengrass V2** | 엣지 디바이스용 IoT 런타임 |
| **코어 디바이스** | Greengrass가 설치된 라즈베리파이 |
| **컴포넌트** | 모듈식 소프트웨어 단위 (레시피 + 아티팩트) |
| **배포** | 컴포넌트를 디바이스에 설치하는 작업 |
| **S3 버킷** | 컴포넌트 아티팩트 저장소 |

---

## 다음 단계

AWS Greengrass 개념을 이해했습니다!

다음 문서에서는 **라즈베리파이5에 Greengrass를 설치**하고 AWS에 연결합니다.

➡️ [05. 라즈베리파이5 환경 설정](05-raspberry-pi-setup.md)

---

## 체크리스트

- [ ] Greengrass V2 개념 이해 완료
- [ ] 컴포넌트/레시피 개념 이해
- [ ] 배포 프로세스 이해
- [ ] S3 버킷 생성 완료
- [ ] 버킷 정책 설정 완료
- [ ] 폴더 구조 생성 완료
