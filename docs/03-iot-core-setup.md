# 03. AWS IoT Core 설정

이 문서에서는 AWS IoT Core를 설정하여 라즈베리파이가 AWS 클라우드와 안전하게 통신할 수 있도록 준비합니다.

## 목차
1. [AWS IoT Core 개요](#1-aws-iot-core-개요)
2. [IoT Core 콘솔 접속](#2-iot-core-콘솔-접속)
3. [Thing 생성](#3-thing-생성)
4. [인증서 생성 및 다운로드](#4-인증서-생성-및-다운로드)
5. [IoT 정책 생성](#5-iot-정책-생성)
6. [연결 테스트](#6-연결-테스트)

---

## 1. AWS IoT Core 개요

### 1.1 AWS IoT Core란?

AWS IoT Core는 IoT 디바이스를 AWS 클라우드에 연결하는 관리형 서비스입니다.

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          AWS IoT Core 구성 요소                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌──────────────┐    ┌──────────────┐    ┌──────────────────────────┐ │
│   │    Thing     │    │  Certificate │    │        Policy            │ │
│   │  (사물/장치) │───▶│   (인증서)   │───▶│       (정책)             │ │
│   │              │    │              │    │                          │ │
│   │ 라즈베리파이  │    │ 암호화 통신   │    │ 허용된 작업 정의          │ │
│   └──────────────┘    └──────────────┘    └──────────────────────────┘ │
│          │                                                              │
│          │  MQTT/HTTPS                                                  │
│          ▼                                                              │
│   ┌──────────────────────────────────────────────────────────────────┐ │
│   │                    Message Broker (메시지 브로커)                  │ │
│   │                                                                   │ │
│   │  Topic: ppe/alerts        Topic: ppe/status                      │ │
│   │  ┌────────────────┐       ┌────────────────┐                     │ │
│   │  │ PPE 미착용 알림 │       │ 디바이스 상태  │                     │ │
│   │  └────────────────┘       └────────────────┘                     │ │
│   └──────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.2 핵심 개념

| 개념 | 설명 | 우리 프로젝트에서 |
|------|------|------------------|
| **Thing** | AWS에서 물리적 디바이스를 표현 | 라즈베리파이5 |
| **Certificate** | 디바이스 인증을 위한 X.509 인증서 | 라즈베리파이에 저장 |
| **Policy** | 디바이스가 수행할 수 있는 IoT 작업 정의 | MQTT 발행/구독 권한 |
| **Topic** | 메시지가 발행/구독되는 채널 | ppe/alerts, ppe/status |
| **MQTT** | IoT 디바이스용 경량 메시지 프로토콜 | 알림 전송에 사용 |

### 1.3 MQTT 프로토콜 이해

```
MQTT 통신 방식:

  발행자(Publisher)           브로커(Broker)         구독자(Subscriber)
       │                          │                       │
       │   PUBLISH                │                       │
       │   topic: ppe/alerts     │                       │
       │   payload: {...}         │   PUSH                │
       │ ─────────────────────▶  │ ─────────────────────▶│
       │                          │                       │
       │                          │                       │
       │                    구독자가 미리 구독(SUBSCRIBE)한   │
       │                    topic에 메시지가 도착하면        │
       │                    브로커가 자동으로 전달            │
       │                          │                       │
```

**토픽(Topic) 예시:**
- `ppe/alerts` - PPE 미착용 알림
- `ppe/status` - 디바이스 상태
- `ppe/detection/+` - 감지 결과 (`+`는 와일드카드)

---

## 2. IoT Core 콘솔 접속

### 2.1 서비스 검색

1. AWS 콘솔 상단 검색창에 **"IoT Core"** 입력
2. **"IoT Core"** 서비스 클릭

```
┌─────────────────────────────────────────────────────────────┐
│  🔍 IoT Core                                                │
│  ─────────────────────────────────────────────────────────  │
│  📦 IoT Core                                               │
│     Connect devices to the cloud                            │
│                                                             │
│  📦 IoT Greengrass                                         │
│     Run local compute, messaging, and ML on edge devices    │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 IoT Core 대시보드

```
┌─────────────────────────────────────────────────────────────────────────┐
│  AWS IoT                                                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  좌측 메뉴:                        메인 화면:                            │
│  ┌────────────────────┐           ┌─────────────────────────────────┐  │
│  │ 모든 디바이스       │           │                                 │  │
│  │   └ 사물(Things)   │◀── 여기   │  AWS IoT에 오신 것을 환영합니다   │  │
│  │                    │           │                                 │  │
│  │ 연결(Connect)      │           │  [빠른 연결]  [설명서]           │  │
│  │                    │           │                                 │  │
│  │ 관리(Manage)       │           └─────────────────────────────────┘  │
│  │   └ 사물           │                                                │
│  │   └ 사물 유형       │                                                │
│  │   └ 사물 그룹       │                                                │
│  │                    │                                                │
│  │ 보안(Security)     │                                                │
│  │   └ 인증서         │◀── 여기                                        │
│  │   └ 정책           │◀── 여기                                        │
│  │                    │                                                │
│  │ 메시지 라우팅       │                                                │
│  │                    │                                                │
│  │ 설정(Settings)     │◀── 엔드포인트 확인                              │
│  └────────────────────┘                                                │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 3. Thing 생성

"Thing"은 AWS IoT에서 물리적 디바이스(라즈베리파이)를 논리적으로 표현합니다.

### 3.1 Thing 생성 시작

1. 좌측 메뉴에서 **"관리(Manage)"** → **"모든 디바이스"** → **"사물(Things)"**
2. **"사물 생성(Create things)"** 클릭

### 3.2 생성할 사물 수 선택

```
┌─────────────────────────────────────────────────────────────┐
│                  생성할 사물 수 지정                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  (●) 단일 사물 생성                                          │
│      개별 IoT 디바이스 1개 생성                              │
│                                                             │
│  ( ) 여러 사물 생성                                          │
│      대량의 디바이스를 한 번에 등록                           │
│                                                             │
│  [다음]                                                      │
└─────────────────────────────────────────────────────────────┘
```

**"단일 사물 생성"** 선택 후 **다음**

### 3.3 사물 속성 지정

```
┌─────────────────────────────────────────────────────────────┐
│                      사물 속성 지정                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  사물 이름*: [RaspberryPi5-PPE-Detector    ]                │
│                                                             │
│  ⚠️ 이름은 나중에 변경할 수 없습니다!                         │
│     영문, 숫자, 하이픈(-), 언더스코어(_)만 사용               │
│                                                             │
│  ─────────────────────────────────────────────────────────  │
│  사물 유형 (선택사항):                                       │
│  [사물 유형 없음                        ▼]                  │
│                                                             │
│  ─────────────────────────────────────────────────────────  │
│  검색 가능한 사물 속성 (선택사항):                            │
│                                                             │
│  속성 추가:                                                  │
│  키: [location    ]  값: [factory-floor-1    ]              │
│  키: [device-type ]  값: [ppe-detector       ]              │
│                                                             │
│  [다음]                                                      │
└─────────────────────────────────────────────────────────────┘
```

**입력 값:**
- **사물 이름**: `RaspberryPi5-PPE-Detector`
- **속성** (선택사항):
  - location: `factory-floor-1`
  - device-type: `ppe-detector`

---

## 4. 인증서 생성 및 다운로드

인증서는 디바이스가 AWS IoT에 안전하게 연결하기 위한 핵심 요소입니다.

### 4.1 디바이스 인증서 구성

```
┌─────────────────────────────────────────────────────────────┐
│                   디바이스 인증서 - 선택 사항                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  (●) 새 인증서 자동 생성 (권장)                              │
│      AWS IoT가 인증서 및 키 페어를 생성합니다                 │
│                                                             │
│  ( ) 내 인증서 사용                                          │
│      기존 인증서 등록                                        │
│                                                             │
│  ( ) CA 인증서로 생성                                        │
│      자체 CA로 서명된 인증서                                 │
│                                                             │
│  ( ) 인증서 건너뛰기                                         │
│      나중에 인증서 연결                                      │
│                                                             │
│  [다음]                                                      │
└─────────────────────────────────────────────────────────────┘
```

**"새 인증서 자동 생성 (권장)"** 선택

### 4.2 정책 연결

> ⚠️ 아직 정책을 만들지 않았다면, 일단 건너뛰고 [섹션 5](#5-iot-정책-생성)에서 정책을 먼저 만든 후 연결할 수 있습니다.

```
┌─────────────────────────────────────────────────────────────┐
│                     정책 연결                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  정책 검색: [                               ]               │
│                                                             │
│  기존 정책:                                                  │
│  ☐ (정책이 없으면 빈 목록)                                  │
│                                                             │
│  [정책 생성] ← 새 정책을 만들려면 클릭                       │
│                                                             │
│  [사물 생성]                                                 │
└─────────────────────────────────────────────────────────────┘
```

### 4.3 인증서 다운로드

**사물 생성**을 클릭하면 인증서 다운로드 화면이 나타납니다.

```
┌─────────────────────────────────────────────────────────────┐
│         ⚠️ 인증서 및 키 다운로드 - 중요!                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  다음 파일들을 지금 다운로드하세요.                           │
│  이 화면을 닫으면 다시 다운로드할 수 없습니다!                │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 📄 디바이스 인증서           [다운로드]              │   │
│  │    xxxxxxxx-certificate.pem.crt                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 🔑 퍼블릭 키 파일            [다운로드]              │   │
│  │    xxxxxxxx-public.pem.key                          │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 🔐 프라이빗 키 파일          [다운로드] ⚠️ 필수      │   │
│  │    xxxxxxxx-private.pem.key                         │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 🏛️ 루트 CA 인증서            [다운로드]             │   │
│  │    Amazon Root CA 1 / AmazonRootCA1.pem             │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  [완료]                                                      │
└─────────────────────────────────────────────────────────────┘
```

### 4.4 다운로드한 파일 정리

다운로드한 파일들을 다음과 같이 이름을 변경하고 정리합니다:

```
📁 greengrass-certs/
├── 📄 device.pem.crt        # 디바이스 인증서
├── 🔑 public.pem.key        # 퍼블릭 키 (사용 안 함)
├── 🔐 private.pem.key       # 프라이빗 키 ⚠️ 매우 중요!
└── 🏛️ AmazonRootCA1.pem     # 루트 CA 인증서
```

> ⚠️ **보안 주의사항:**
> - `private.pem.key`는 절대 외부에 공유하지 마세요
> - Git에 커밋하지 마세요 (`.gitignore`에 추가)
> - 라즈베리파이에 안전하게 복사해야 합니다

### 4.5 인증서 활성화 확인

1. 좌측 메뉴 **"보안(Security)"** → **"인증서(Certificates)"**
2. 생성된 인증서 클릭
3. **상태**가 "활성(Active)"인지 확인

```
┌─────────────────────────────────────────────────────────────┐
│  인증서 세부 정보                                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  인증서 ID: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx            │
│                                                             │
│  상태: [활성 ✓]                                             │
│                                                             │
│  연결된 사물:                                                │
│  - RaspberryPi5-PPE-Detector                                │
│                                                             │
│  연결된 정책:                                                │
│  - (정책 연결 필요)                                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 5. IoT 정책 생성

IoT 정책은 디바이스가 수행할 수 있는 작업을 정의합니다.

### 5.1 정책 생성 시작

1. 좌측 메뉴 **"보안(Security)"** → **"정책(Policies)"**
2. **"정책 생성(Create policy)"** 클릭

### 5.2 정책 문서 작성

```
┌─────────────────────────────────────────────────────────────┐
│                      정책 생성                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  정책 이름*: [PPEDetectorPolicy            ]                │
│                                                             │
│  정책 문서:                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  빌더 │ JSON │                                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 5.3 JSON 정책 문서

**JSON** 탭을 선택하고 다음 정책을 입력:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowConnect",
      "Effect": "Allow",
      "Action": "iot:Connect",
      "Resource": "arn:aws:iot:ap-northeast-2:*:client/${iot:Connection.Thing.ThingName}"
    },
    {
      "Sid": "AllowPublish",
      "Effect": "Allow",
      "Action": "iot:Publish",
      "Resource": [
        "arn:aws:iot:ap-northeast-2:*:topic/ppe/*",
        "arn:aws:iot:ap-northeast-2:*:topic/$aws/things/${iot:Connection.Thing.ThingName}/shadow/*"
      ]
    },
    {
      "Sid": "AllowSubscribe",
      "Effect": "Allow",
      "Action": "iot:Subscribe",
      "Resource": [
        "arn:aws:iot:ap-northeast-2:*:topicfilter/ppe/*",
        "arn:aws:iot:ap-northeast-2:*:topicfilter/$aws/things/${iot:Connection.Thing.ThingName}/shadow/*"
      ]
    },
    {
      "Sid": "AllowReceive",
      "Effect": "Allow",
      "Action": "iot:Receive",
      "Resource": [
        "arn:aws:iot:ap-northeast-2:*:topic/ppe/*",
        "arn:aws:iot:ap-northeast-2:*:topic/$aws/things/${iot:Connection.Thing.ThingName}/shadow/*"
      ]
    },
    {
      "Sid": "AllowGetThingShadow",
      "Effect": "Allow",
      "Action": [
        "iot:GetThingShadow",
        "iot:UpdateThingShadow",
        "iot:DeleteThingShadow"
      ],
      "Resource": "arn:aws:iot:ap-northeast-2:*:thing/${iot:Connection.Thing.ThingName}"
    }
  ]
}
```

### 5.4 정책 설명

| Statement | 설명 |
|-----------|------|
| **AllowConnect** | 디바이스가 Thing 이름으로 AWS IoT에 연결 |
| **AllowPublish** | `ppe/*` 토픽에 메시지 발행 |
| **AllowSubscribe** | `ppe/*` 토픽 구독 |
| **AllowReceive** | 구독한 토픽에서 메시지 수신 |
| **AllowGetThingShadow** | Thing Shadow(디바이스 상태) 읽기/쓰기 |

### 5.5 정책을 인증서에 연결

1. 좌측 메뉴 **"보안(Security)"** → **"인증서(Certificates)"**
2. 앞서 생성한 인증서 선택
3. **"작업(Actions)"** 드롭다운 → **"정책 연결(Attach policy)"**
4. `PPEDetectorPolicy` 선택 후 **"연결"**

---

## 6. 연결 테스트

### 6.1 IoT 엔드포인트 확인

디바이스가 연결할 AWS IoT 엔드포인트 주소를 확인합니다.

1. 좌측 메뉴 최하단 **"설정(Settings)"** 클릭
2. **"디바이스 데이터 엔드포인트"** 복사

```
┌─────────────────────────────────────────────────────────────┐
│                        설정                                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  디바이스 데이터 엔드포인트                                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ xxxxxxxxxxxxxx-ats.iot.ap-northeast-2.amazonaws.com │   │
│  │                                           [복사]    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ⚠️ 이 엔드포인트는 계정마다 고유합니다.                      │
│     라즈베리파이 설정 시 필요합니다.                          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.2 MQTT 테스트 클라이언트

AWS 콘솔에서 MQTT 메시지를 테스트할 수 있습니다.

1. 좌측 메뉴 **"MQTT 테스트 클라이언트(MQTT test client)"**
2. **"주제 구독(Subscribe to a topic)"** 탭

```
┌─────────────────────────────────────────────────────────────┐
│                    MQTT 테스트 클라이언트                     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  주제 필터: [ppe/#                         ]                │
│             (ppe/ 아래 모든 토픽 구독)                       │
│                                                             │
│  [구독]                                                      │
│                                                             │
│  ─────────────────────────────────────────────────────────  │
│  구독 중인 주제:                                             │
│  - ppe/#                                                    │
│                                                             │
│  수신된 메시지:                                              │
│  (라즈베리파이에서 메시지를 보내면 여기에 표시됩니다)          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.3 테스트 메시지 발행

1. **"주제에 게시(Publish to a topic)"** 탭
2. 토픽: `ppe/test`
3. 메시지:

```json
{
  "message": "Hello from AWS IoT Console",
  "timestamp": "2024-01-15T10:30:00Z"
}
```

4. **"게시"** 클릭
5. 구독 탭에서 메시지 수신 확인

---

## 요약: 생성된 리소스

| 리소스 | 이름/값 | 용도 |
|--------|---------|------|
| Thing | `RaspberryPi5-PPE-Detector` | 디바이스 표현 |
| 인증서 | `device.pem.crt` | 디바이스 인증 |
| 프라이빗 키 | `private.pem.key` | 암호화 |
| 루트 CA | `AmazonRootCA1.pem` | AWS 서버 검증 |
| IoT 정책 | `PPEDetectorPolicy` | 권한 정의 |
| 엔드포인트 | `xxx.iot.ap-northeast-2.amazonaws.com` | 연결 주소 |

---

## 다음 단계

AWS IoT Core 설정이 완료되었습니다!

다음 문서에서는 **AWS IoT Greengrass V2**를 설정하여 엣지 컴퓨팅 환경을 구축합니다.

➡️ [04. AWS IoT Greengrass 설정](04-greengrass-setup.md)

---

## 체크리스트

- [ ] Thing 생성 완료 (`RaspberryPi5-PPE-Detector`)
- [ ] 인증서 생성 및 다운로드 완료
- [ ] IoT 정책 생성 완료 (`PPEDetectorPolicy`)
- [ ] 정책을 인증서에 연결 완료
- [ ] IoT 엔드포인트 주소 복사 완료
- [ ] 인증서 파일을 안전한 곳에 보관
