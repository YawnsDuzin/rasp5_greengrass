# 02. IAM 사용자 및 권한 설정

이 문서에서는 AWS IAM(Identity and Access Management)을 사용하여 보안을 강화하고, IoT Greengrass 프로젝트에 필요한 권한을 설정합니다.

## 목차
1. [IAM 기본 개념](#1-iam-기본-개념)
2. [IAM 관리자 사용자 생성](#2-iam-관리자-사용자-생성)
3. [Greengrass용 IAM 역할 생성](#3-greengrass용-iam-역할-생성)
4. [IAM 정책 이해하기](#4-iam-정책-이해하기)
5. [보안 모범 사례](#5-보안-모범-사례)

---

## 1. IAM 기본 개념

### 1.1 왜 IAM이 필요한가?

AWS 계정을 만들면 "루트 사용자"가 생성됩니다. 루트 사용자는 **모든 권한**을 가지고 있어, 보안상 위험합니다.

```
루트 사용자의 위험성:
┌─────────────────────────────────────────────────────────────┐
│  루트 사용자 = 집의 마스터키                                  │
│                                                             │
│  · 모든 서비스 접근 가능                                     │
│  · 계정 삭제 가능                                            │
│  · 결제 정보 변경 가능                                       │
│  · 비밀번호 유출 시 전체 피해                                 │
│                                                             │
│  ⚠️ 일상적인 작업에 루트 사용자 사용 금지!                    │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 IAM 주요 개념

| 개념 | 설명 | 비유 |
|------|------|------|
| **사용자 (User)** | AWS에 접근하는 개인/서비스 | 회사 직원 |
| **그룹 (Group)** | 사용자들의 모음 | 부서 |
| **역할 (Role)** | 임시로 부여되는 권한 세트 | 임시 출입증 |
| **정책 (Policy)** | 권한을 정의하는 JSON 문서 | 출입 규정 |

### 1.3 IAM 구조 다이어그램

```
┌─────────────────────────────────────────────────────────────┐
│                      AWS 계정                                │
│  ┌──────────────────────────────────────────────────────┐  │
│  │                    IAM                                │  │
│  │                                                       │  │
│  │   ┌─────────────┐      ┌─────────────────────────┐  │  │
│  │   │   사용자     │      │        정책             │  │  │
│  │   │  ┌───────┐  │      │  ┌─────────────────┐   │  │  │
│  │   │  │ User1 │──┼──────┼─▶│ AdministratorAc │   │  │  │
│  │   │  └───────┘  │      │  │ cess            │   │  │  │
│  │   │  ┌───────┐  │      │  └─────────────────┘   │  │  │
│  │   │  │ User2 │  │      │  ┌─────────────────┐   │  │  │
│  │   │  └───────┘  │      │  │ IoTFullAccess   │   │  │  │
│  │   └─────────────┘      │  └─────────────────┘   │  │  │
│  │                        └─────────────────────────┘  │  │
│  │   ┌─────────────┐      ┌─────────────────────────┐  │  │
│  │   │    그룹     │      │        역할             │  │  │
│  │   │ ┌─────────┐│      │  ┌─────────────────┐   │  │  │
│  │   │ │ Admins  ││      │  │ GreengrassRole  │   │  │  │
│  │   │ └─────────┘│      │  └─────────────────┘   │  │  │
│  │   └─────────────┘      └─────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. IAM 관리자 사용자 생성

루트 사용자 대신 일상적인 작업에 사용할 IAM 관리자 사용자를 만듭니다.

### 2.1 IAM 콘솔 접속

1. AWS 콘솔 상단 검색창에 **"IAM"** 입력
2. **"IAM"** 서비스 클릭

### 2.2 사용자 생성 시작

1. 좌측 메뉴에서 **"사용자(Users)"** 클릭
2. **"사용자 생성(Create user)"** 버튼 클릭

### 2.3 사용자 세부 정보 지정

```
┌─────────────────────────────────────────────────────────────┐
│                    사용자 세부 정보 지정                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  사용자 이름: [admin-user                    ]              │
│                                                             │
│  ☑ AWS Management Console에 대한 사용자 액세스 권한 제공     │
│                                                             │
│  콘솔 암호:                                                  │
│  (●) 자동 생성된 암호                                        │
│  ( ) 사용자 지정 암호                                        │
│                                                             │
│  ☑ 사용자는 다음 로그인 시 새 암호를 생성해야 합니다.         │
│                                                             │
│  [다음]                                                      │
└─────────────────────────────────────────────────────────────┘
```

### 2.4 권한 설정

```
┌─────────────────────────────────────────────────────────────┐
│                      권한 설정                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  권한 옵션:                                                  │
│  (●) 직접 정책 연결                                          │
│  ( ) 그룹에 사용자 추가                                      │
│  ( ) 권한 복사                                               │
│                                                             │
│  ─────────────────────────────────────────────────────────  │
│  권한 정책 검색: [administrator                ]             │
│                                                             │
│  ☑ AdministratorAccess                                     │
│    AWS 서비스 및 리소스에 대한 전체 액세스를 제공합니다       │
│    관리형 정책 - AWS                                        │
│                                                             │
│  [다음]                                                      │
└─────────────────────────────────────────────────────────────┘
```

### 2.5 검토 및 생성

설정을 확인하고 **"사용자 생성"** 클릭

### 2.6 로그인 정보 저장

```
┌─────────────────────────────────────────────────────────────┐
│               ✓ 사용자가 성공적으로 생성됨                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  콘솔 로그인 URL:                                           │
│  https://123456789012.signin.aws.amazon.com/console         │
│                                                 [복사]      │
│                                                             │
│  사용자 이름: admin-user                                    │
│  콘솔 암호: ******** (표시/다운로드)                        │
│                                                             │
│  ⚠️ 이 창을 닫으면 암호를 다시 볼 수 없습니다!               │
│                                                             │
│  [.csv 파일 다운로드]                                       │
└─────────────────────────────────────────────────────────────┘
```

> ⚠️ **중요**: 반드시 `.csv 파일 다운로드`를 클릭하여 자격 증명을 안전하게 저장하세요!

### 2.7 새 사용자로 로그인

1. 로그아웃
2. 콘솔 로그인 URL 접속
3. **"IAM 사용자"** 선택
4. 계정 ID (12자리 숫자) 또는 계정 별칭 입력
5. 사용자 이름과 임시 비밀번호로 로그인
6. 새 비밀번호 설정

---

## 3. Greengrass용 IAM 역할 생성

Greengrass 코어 디바이스가 AWS 서비스에 접근하려면 적절한 역할(Role)이 필요합니다.

### 3.1 역할(Role)이란?

```
역할(Role) vs 사용자(User):

┌─────────────────────────────────────────────────────────────┐
│                                                             │
│  사용자(User):                                              │
│  · 영구적인 자격 증명 (Access Key)                          │
│  · 특정 사람/서비스에 고정                                   │
│  · 예: 개발자 계정, CI/CD 서비스 계정                        │
│                                                             │
│  역할(Role):                                                │
│  · 임시 자격 증명                                           │
│  · 필요할 때 "assume(수임)"                                 │
│  · 예: EC2가 S3 접근, Lambda가 DynamoDB 접근                │
│       Greengrass가 IoT Core 접근                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 Greengrass 서비스 역할 생성

#### 3.2.1 역할 생성 시작

1. IAM 콘솔에서 좌측 **"역할(Roles)"** 클릭
2. **"역할 생성(Create role)"** 클릭

#### 3.2.2 신뢰할 수 있는 엔터티 선택

```
┌─────────────────────────────────────────────────────────────┐
│                신뢰할 수 있는 엔터티 선택                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  신뢰할 수 있는 엔터티 유형:                                  │
│  (●) AWS 서비스                                             │
│  ( ) AWS 계정                                               │
│  ( ) 웹 자격 증명                                            │
│  ( ) SAML 2.0 연동                                          │
│  ( ) 사용자 지정 신뢰 정책                                   │
│                                                             │
│  ─────────────────────────────────────────────────────────  │
│  사용 사례:                                                  │
│  서비스: [Greengrass                    ] ← 검색            │
│                                                             │
│  (●) Greengrass                                             │
│      Allows Greengrass core devices to call AWS services    │
│                                                             │
│  [다음]                                                      │
└─────────────────────────────────────────────────────────────┘
```

#### 3.2.3 권한 정책 추가

다음 정책들을 검색하여 선택합니다:

```
┌─────────────────────────────────────────────────────────────┐
│                     권한 정책 추가                           │
├─────────────────────────────────────────────────────────────┤
│  검색: [                                    ]               │
│                                                             │
│  ☑ AWSIoTThingsRegistration                                │
│    Thing 등록 권한                                          │
│                                                             │
│  ☑ AmazonS3ReadOnlyAccess                                  │
│    S3에서 컴포넌트 아티팩트 다운로드                         │
│                                                             │
│  ☑ CloudWatchLogsFullAccess                                │
│    로그 전송 (선택사항이지만 디버깅에 유용)                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 3.2.4 역할 이름 지정

```
┌─────────────────────────────────────────────────────────────┐
│                     역할 세부 정보                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  역할 이름: [GreengrassV2TokenExchangeRole   ]              │
│                                                             │
│  설명: [Role for Greengrass V2 core devices  ]             │
│                                                             │
│  [역할 생성]                                                 │
└─────────────────────────────────────────────────────────────┘
```

### 3.3 토큰 교환 역할 별칭 생성 (선택사항)

Greengrass는 "토큰 교환 역할"을 사용하여 AWS 자격 증명을 얻습니다.
이는 Greengrass 설치 시 자동으로 구성될 수 있습니다.

---

## 4. IAM 정책 이해하기

### 4.1 정책(Policy) 구조

IAM 정책은 JSON 형식으로 작성됩니다:

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "iot:Connect",
                "iot:Publish",
                "iot:Subscribe",
                "iot:Receive"
            ],
            "Resource": "*"
        }
    ]
}
```

### 4.2 정책 구성 요소

| 요소 | 설명 | 예시 |
|------|------|------|
| **Version** | 정책 언어 버전 | "2012-10-17" (항상 이 값 사용) |
| **Statement** | 권한 규칙 배열 | [...] |
| **Effect** | 허용/거부 | "Allow" 또는 "Deny" |
| **Action** | 허용할 작업 | "s3:GetObject", "iot:Publish" |
| **Resource** | 대상 리소스 | ARN 또는 "*" (모든 리소스) |

### 4.3 PPE 프로젝트용 커스텀 정책 생성

우리 프로젝트에 필요한 최소 권한 정책을 만들어봅시다.

#### 4.3.1 정책 생성

1. IAM 콘솔 → **"정책(Policies)"** → **"정책 생성"**
2. **"JSON"** 탭 선택

#### 4.3.2 정책 JSON 입력

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "IoTCoreAccess",
            "Effect": "Allow",
            "Action": [
                "iot:Connect",
                "iot:Publish",
                "iot:Subscribe",
                "iot:Receive",
                "iot:GetThingShadow",
                "iot:UpdateThingShadow"
            ],
            "Resource": [
                "arn:aws:iot:ap-northeast-2:*:client/${iot:Connection.Thing.ThingName}",
                "arn:aws:iot:ap-northeast-2:*:topic/ppe/*",
                "arn:aws:iot:ap-northeast-2:*:topicfilter/ppe/*"
            ]
        },
        {
            "Sid": "S3ModelAccess",
            "Effect": "Allow",
            "Action": [
                "s3:GetObject",
                "s3:ListBucket"
            ],
            "Resource": [
                "arn:aws:s3:::your-ppe-bucket",
                "arn:aws:s3:::your-ppe-bucket/*"
            ]
        },
        {
            "Sid": "CloudWatchLogs",
            "Effect": "Allow",
            "Action": [
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:PutLogEvents"
            ],
            "Resource": "arn:aws:logs:ap-northeast-2:*:log-group:/aws/greengrass/*"
        }
    ]
}
```

#### 4.3.3 정책 이름 지정

```
정책 이름: PPEDetectorPolicy
설명: Custom policy for PPE Detector Greengrass component
```

---

## 5. 보안 모범 사례

### 5.1 IAM 보안 체크리스트

```
┌─────────────────────────────────────────────────────────────┐
│                    IAM 보안 체크리스트                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ☐ 루트 사용자에 MFA(다단계 인증) 활성화                     │
│  ☐ 일상 작업에 IAM 사용자 사용                              │
│  ☐ IAM 사용자에게도 MFA 활성화                              │
│  ☐ 최소 권한 원칙 적용                                      │
│  ☐ Access Key 정기적 교체                                  │
│  ☐ 사용하지 않는 자격 증명 비활성화                          │
│  ☐ 강력한 비밀번호 정책 설정                                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 루트 사용자 MFA 설정

1. 루트 사용자로 로그인
2. 우측 상단 계정 이름 → **"보안 자격 증명"**
3. **"MFA(다단계 인증)"** 섹션에서 **"MFA 활성화"**

```
┌─────────────────────────────────────────────────────────────┐
│                      MFA 디바이스 선택                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  (●) 인증 앱 (권장)                                         │
│      Google Authenticator, Microsoft Authenticator 등       │
│                                                             │
│  ( ) 보안 키                                                │
│      YubiKey, Titan 등                                      │
│                                                             │
│  ( ) 하드웨어 TOTP 토큰                                      │
│      물리적 토큰 디바이스                                    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 5.3 프로그래밍 방식 액세스 키 생성

Greengrass 설치 시 필요한 액세스 키를 생성합니다.

1. IAM → 사용자 → admin-user 선택
2. **"보안 자격 증명"** 탭
3. **"액세스 키 만들기"** 클릭

```
┌─────────────────────────────────────────────────────────────┐
│                     액세스 키 사용 사례                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ( ) 명령줄 인터페이스(CLI)                                  │
│  ( ) 로컬 코드                                              │
│  ( ) AWS 외부에서 실행되는 애플리케이션                       │
│  (●) 기타                                                   │
│                                                             │
│  설명 태그 (선택사항):                                       │
│  [Greengrass setup key                   ]                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 5.4 액세스 키 저장

```
┌─────────────────────────────────────────────────────────────┐
│               ✓ 액세스 키가 생성되었습니다                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Access Key ID:     AKIAIOSFODNN7EXAMPLE                   │
│                                                [복사]       │
│                                                             │
│  Secret Access Key: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLE │
│                                                [표시/복사]  │
│                                                             │
│  ⚠️ 이 창을 닫으면 Secret Access Key를 다시 볼 수 없습니다!  │
│                                                             │
│  [.csv 파일 다운로드]    [완료]                              │
└─────────────────────────────────────────────────────────────┘
```

> ⚠️ **매우 중요**:
> - Secret Access Key는 **절대** 외부에 공개하지 마세요
> - Git 저장소에 커밋하지 마세요
> - 안전한 비밀번호 관리자에 저장하세요

---

## 요약

이 문서에서 수행한 작업:

1. ✅ IAM 기본 개념 이해
2. ✅ IAM 관리자 사용자 생성 (admin-user)
3. ✅ Greengrass용 서비스 역할 생성 (GreengrassV2TokenExchangeRole)
4. ✅ PPE 프로젝트용 커스텀 정책 생성 (PPEDetectorPolicy)
5. ✅ 보안 모범 사례 적용 (MFA, 액세스 키)

---

## 다음 단계

IAM 설정이 완료되었습니다!

다음 문서에서는 **AWS IoT Core**를 설정하여 디바이스 연결을 준비합니다.

➡️ [03. AWS IoT Core 설정](03-iot-core-setup.md)

---

## 체크리스트

- [ ] IAM 관리자 사용자 생성 완료
- [ ] 관리자 사용자로 콘솔 로그인 성공
- [ ] Greengrass 서비스 역할 생성 완료
- [ ] 루트 사용자 MFA 활성화
- [ ] 액세스 키 생성 및 안전하게 저장
